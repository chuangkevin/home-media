name: Deploy to Server via Tailscale

on:
  workflow_run:
    workflows: ["Build and Push Docker Images"]
    types:
      - completed
    branches:
      - main
  workflow_dispatch:  # å…è¨±æ‰‹å‹•è§¸ç™¼

env:
  DOCKERHUB_USERNAME: kevin950805

jobs:
  deploy:
    runs-on: ubuntu-latest
    # åªåœ¨ CI æˆåŠŸå¾ŒåŸ·è¡Œ
    if: ${{ github.event.workflow_run.conclusion == 'success' || github.event_name == 'workflow_dispatch' }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Connect to Tailscale
        uses: tailscale/github-action@v2
        with:
          oauth-client-id: ${{ secrets.TS_OAUTH_CLIENT_ID }}
          oauth-secret: ${{ secrets.TS_OAUTH_SECRET }}
          tag: github-actions

      - name: Test Tailscale Connection
        run: |
          echo "Testing connection to deployment server..."
          tailscale status
          ping -c 3 ${{ secrets.DEPLOY_SERVER_IP }}

      - name: Setup SSH
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.DEPLOY_SSH_KEY }}" > ~/.ssh/deploy_key
          chmod 600 ~/.ssh/deploy_key
          ssh-keyscan -H ${{ secrets.DEPLOY_SERVER_IP }} >> ~/.ssh/known_hosts

      - name: Deploy via SSH
        env:
          DEPLOY_SERVER_IP: ${{ secrets.DEPLOY_SERVER_IP }}
          DEPLOY_USER: ${{ secrets.DEPLOY_USER }}
          DEPLOY_PATH: ${{ secrets.DEPLOY_PATH }}
        run: |
          ssh -i ~/.ssh/deploy_key ${DEPLOY_USER}@${DEPLOY_SERVER_IP} "
            set -e

            echo 'ðŸ“ Navigating to deployment directory...'
            cd ${DEPLOY_PATH}

            echo 'ðŸ”„ Pulling latest Docker images...'
            docker compose -f docker-compose.yml pull

            echo 'ðŸ›‘ Stopping existing containers...'
            docker compose -f docker-compose.yml down

            echo 'ðŸš€ Starting updated containers...'
            docker compose -f docker-compose.yml up -d

            echo 'ðŸ§¹ Cleaning up old images...'
            docker image prune -af --filter \"until=24h\"

            echo 'âœ… Deployment completed successfully!'
            docker compose -f docker-compose.yml ps
          "

      - name: Health Check
        run: |
          echo "ðŸ¥ Performing health check..."
          sleep 10

          # æª¢æŸ¥ backend health
          curl -f http://${{ secrets.DEPLOY_SERVER_IP }}:3001/health || exit 1

          echo "âœ… Health check passed!"

      - name: Deployment Summary
        if: always()
        run: |
          echo "## ðŸš€ Deployment Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- **Status**: ${{ job.status }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Server**: \`${{ secrets.DEPLOY_SERVER_IP }}\`" >> $GITHUB_STEP_SUMMARY
          echo "- **Images**:" >> $GITHUB_STEP_SUMMARY
          echo "  - Frontend: \`${{ env.DOCKERHUB_USERNAME }}/home-media-frontend:latest\`" >> $GITHUB_STEP_SUMMARY
          echo "  - Backend: \`${{ env.DOCKERHUB_USERNAME }}/home-media-backend:latest\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Deployed at: $(date -u +'%Y-%m-%d %H:%M:%S UTC')" >> $GITHUB_STEP_SUMMARY

      - name: Notify on Failure
        if: failure()
        run: |
          echo "âŒ Deployment failed! Please check the logs above." >> $GITHUB_STEP_SUMMARY
